---
interface Props {
  limit?: number;
}

const { limit = 5 } = Astro.props as Props;
const requestUrl = Astro.request?.url ?? "https://www.nbdevlab.com";
const canFetchServer = typeof Astro.request !== "undefined";
let items: Array<{
  type: string;
  repo: string;
  url: string;
  title: string;
  timestamp: string;
}> = [];
let errored = false;

function formatRelativeTime(iso: string): string {
  try {
    const date = new Date(iso);
    if (Number.isNaN(date.getTime())) return "just now";
    const diffSeconds = Math.round((Date.now() - date.getTime()) / 1000);
    const formatter = new Intl.RelativeTimeFormat("en", { numeric: "auto" });
    const intervals: Array<{ limit: number; divisor: number; unit: Intl.RelativeTimeFormatUnit }> = [
      { limit: 60, divisor: 1, unit: "seconds" },
      { limit: 3600, divisor: 60, unit: "minutes" },
      { limit: 86400, divisor: 3600, unit: "hours" },
      { limit: 604800, divisor: 86400, unit: "days" },
      { limit: 2419200, divisor: 604800, unit: "weeks" },
      { limit: 29030400, divisor: 2419200, unit: "months" },
      { limit: Number.POSITIVE_INFINITY, divisor: 29030400, unit: "years" },
    ];
    const absSeconds = Math.abs(diffSeconds);
    for (const { limit, divisor, unit } of intervals) {
      if (absSeconds < limit) {
        const value = Math.round(diffSeconds / divisor);
        return formatter.format(-value, unit);
      }
    }
    return formatter.format(0, "seconds");
  } catch {
    return "just now";
  }
}

if (canFetchServer) {
  try {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 3500);
    const apiUrl = new URL("/api/github", requestUrl);
    const response = await fetch(apiUrl.toString(), {
      headers: { Accept: "application/json" },
      signal: controller.signal,
    });
    clearTimeout(timeout);
    if (response.ok) {
      const data = (await response.json()) as { items?: typeof items };
      if (Array.isArray(data.items)) {
        items = data.items.slice(0, limit);
      }
    } else {
      errored = true;
    }
  } catch (error) {
    if (import.meta.env.DEV) {
      console.error("github-activity", error);
    }
    errored = true;
  }
}

const hasItems = items.length > 0;
const cardId = `github-card-${Math.random().toString(36).slice(2, 10)}`;
const shouldHydrateClient = !canFetchServer || errored;
const initialState = hasItems ? "ready" : shouldHydrateClient ? "loading" : "empty";
const emptyMessage = errored ? "Unable to load GitHub activity right now." : "No recent public activity yet.";
---
<section
  class="card github-card"
  aria-labelledby="github-activity-heading"
  role="region"
  id={cardId}
  data-github-card
  data-state={initialState}
  data-fetch={shouldHydrateClient ? "true" : "false"}
  data-empty-message={emptyMessage}
  data-limit={String(limit)}
>
  <div class="card__header">
    <h2 id="github-activity-heading">Latest GitHub activity</h2>
    <p class="muted">Edge-cached events refreshed regularly without over-polling the API.</p>
  </div>
  <div class="github-card__actions" hidden={initialState === "ready"}>
    <button type="button" class="button button--ghost" data-retry hidden>Retry</button>
  </div>
  <div
    class="github-card__loading"
    role="status"
    aria-live="polite"
    data-loading
    hidden={initialState !== "loading"}
  >
    <span class="skeleton" style="width: 70%"></span>
    <span class="skeleton" style="width: 55%"></span>
    <span class="skeleton" style="width: 62%"></span>
  </div>
  <ol class="github-card__list" data-items hidden={initialState !== "ready"}>
    {items.map((item) => (
      <li class="github-card__item" data-type={item.type}>
        <div class="github-card__meta">
          <span class="github-card__repo" aria-label={`Repository ${item.repo}`}>{item.repo}</span>
          <span>{item.type.replace("Event", "")}</span>
          <span>{formatRelativeTime(item.timestamp)}</span>
        </div>
        <a
          class="github-card__link"
          href={item.url}
          target="_blank"
          rel="noopener noreferrer"
          title={item.title}
        >
          <span>{item.title}</span>
          <span aria-hidden="true">↗</span>
        </a>
      </li>
    ))}
  </ol>
  <div class="github-card__empty muted" role="status" aria-live="polite" data-empty hidden={initialState !== "empty"}>
    {emptyMessage}
  </div>
</section>

<script is:inline>
  (() => {
    const card = document.getElementById({JSON.stringify(cardId)});
    if (!card) return;
    const loading = card.querySelector("[data-loading]");
    const list = card.querySelector("[data-items]");
    const empty = card.querySelector("[data-empty]");
    const retry = card.querySelector("[data-retry]");
    const actions = card.querySelector(".github-card__actions");
    const limit = Number(card.dataset.limit ?? "5") || 5;
    let skeletonTimer;

    const setState = (state) => {
      card.dataset.state = state;
      loading?.toggleAttribute("hidden", state !== "loading");
      list?.toggleAttribute("hidden", state !== "ready");
      empty?.toggleAttribute("hidden", state !== "empty");
      retry?.toggleAttribute("hidden", state !== "empty");
      actions?.toggleAttribute("hidden", state === "ready");
    };

    const formatRelativeTime = (value) => {
      try {
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return "just now";
        const diffSeconds = Math.round((Date.now() - date.getTime()) / 1000);
        const formatter = new Intl.RelativeTimeFormat("en", { numeric: "auto" });
        const intervals = [
          { limit: 60, divisor: 1, unit: "seconds" },
          { limit: 3600, divisor: 60, unit: "minutes" },
          { limit: 86400, divisor: 3600, unit: "hours" },
          { limit: 604800, divisor: 86400, unit: "days" },
          { limit: 2419200, divisor: 604800, unit: "weeks" },
          { limit: 29030400, divisor: 2419200, unit: "months" },
          { limit: Number.POSITIVE_INFINITY, divisor: 29030400, unit: "years" },
        ];
        const absSeconds = Math.abs(diffSeconds);
        for (const interval of intervals) {
          if (absSeconds < interval.limit) {
            const value = Math.round(diffSeconds / interval.divisor);
            return formatter.format(-value, interval.unit);
          }
        }
        return formatter.format(0, "seconds");
      } catch {
        return "just now";
      }
    };

    const renderItems = (items) => {
      if (!list) return;
      list.innerHTML = items
        .map(
          (item) => `
            <li class="github-card__item" data-type="${item.type}">
              <div class="github-card__meta">
                <span class="github-card__repo" aria-label="Repository ${item.repo}">${item.repo}</span>
                <span>${item.type.replace("Event", "")}</span>
                <span>${formatRelativeTime(item.timestamp)}</span>
              </div>
              <a class="github-card__link" href="${item.url}" target="_blank" rel="noopener noreferrer" title="${item.title}">
                <span>${item.title}</span>
                <span aria-hidden="true">↗</span>
              </a>
            </li>
          `
        )
        .join("");
    };

    const setEmptyMessage = (message) => {
      if (empty) {
        empty.textContent = message;
      }
    };

    const fetchActivity = () => {
      setState("loading");
      if (skeletonTimer) {
        window.clearTimeout(skeletonTimer);
      }
      skeletonTimer = window.setTimeout(() => {
        if (card.dataset.state === "loading") {
          setEmptyMessage(card.dataset.emptyMessage ?? "No recent activity");
          setState("empty");
        }
      }, 2000);

      const controller = new AbortController();
      const abortTimer = window.setTimeout(() => controller.abort(), 3500);
      fetch(`/api/github?limit=${limit}`, {
        signal: controller.signal,
        headers: { Accept: "application/json" },
      })
        .then((response) => (response.ok ? response.json() : Promise.reject(new Error("Request failed"))))
        .then((data) => {
          if (!Array.isArray(data?.items) || data.items.length === 0) {
            setEmptyMessage(card.dataset.emptyMessage ?? "No recent activity");
            setState("empty");
            return;
          }
          renderItems(data.items.slice(0, limit));
          setState("ready");
        })
        .catch(() => {
          setEmptyMessage("Unable to load GitHub activity right now.");
          setState("empty");
        })
        .finally(() => {
          window.clearTimeout(abortTimer);
          if (skeletonTimer) {
            window.clearTimeout(skeletonTimer);
          }
        });
    };

    if (card.dataset.state === "loading" && card.dataset.fetch === "true") {
      fetchActivity();
    }

    retry?.addEventListener("click", fetchActivity);
  })();
</script>
