---
import BaseHead from "../components/BaseHead.astro";
import "../styles/global.css";
import BackToTopButton from "../components/BackToTopButton.astro";
import { SearchDialog } from "../components/SearchDialog";

interface Props {
  title?: string;
  description?: string;
  image?: string;
  structuredData?: Array<Record<string, unknown>> | Record<string, unknown>;
}

const {
  title = "nbdevlab â€” Nathan Bullock",
  description = "Builder notes, project breakdowns, and homelab experiments from nbdevlab.",
  image,
  structuredData,
} = Astro.props as Props;

const NAV_LINKS = [
  { href: "/", label: "Home" },
  { href: "/about/", label: "About" },
  { href: "/projects/", label: "Projects" },
  { href: "/uses/", label: "Uses" },
  { href: "/now/", label: "Now" },
  { href: "/status/", label: "Status" },
  { href: "/admin/", label: "Admin" },
] as const;

const currentPath = Astro.url.pathname.replace(/\/+$/g, "/");

function isActive(href: string) {
  return href === "/" ? currentPath === "/" : currentPath.startsWith(href);
}

const footerYear = new Date().getFullYear();
---
<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <BaseHead title={title} description={description} image={image} structuredData={structuredData} />
    <script is:inline>
      (() => {
        const storageKey = "nbdevlab-theme";
        const root = document.documentElement;
        try {
          const stored = localStorage.getItem(storageKey);
          if (stored === "dark" || stored === "light") {
            root.dataset.theme = stored;
            root.classList.toggle("dark", stored === "dark");
            return;
          }
        } catch (error) {
          console.warn("theme-init", error);
        }
        const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
        const theme = prefersDark ? "dark" : "light";
        root.dataset.theme = theme;
        root.classList.toggle("dark", theme === "dark");
      })();
    </script>
  </head>
  <body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <header class="site-header" role="banner">
      <div class="layout-shell">
        <div class="site-header__inner">
          <a class="site-header__brand" href="/" aria-label="nbdevlab home">
            <span class="site-header__mark" aria-hidden="true">NB</span>
            <span class="site-header__title" aria-hidden="true">nbdevlab</span>
          </a>
          <button
            type="button"
            class="site-header__toggle"
            data-nav-toggle
            aria-label="Toggle navigation"
            aria-controls="site-navigation"
            aria-expanded="false"
          >
            Menu
          </button>
          <nav id="site-navigation" class="site-header__nav" aria-label="Primary navigation" data-nav>
            <div class="site-header__links">
              {NAV_LINKS.map((item) => (
                <a class={isActive(item.href) ? "is-active" : undefined} href={item.href}>
                  <span>{item.label}</span>
                </a>
              ))}
            </div>
            <div class="site-header__utilities">
              <button type="button" class="theme-toggle" data-theme-toggle aria-pressed="false">
                <span aria-hidden="true">ðŸŒ“</span>
                <span>Theme</span>
              </button>
              <SearchDialog client:load />
            </div>
          </nav>
        </div>
      </div>
    </header>
    <main id="main-content" class="site-main">
      <div class="layout-shell">
        <slot />
      </div>
    </main>
    <footer class="site-footer">
      <div class="layout-shell">
        <div class="site-footer__row">
          <p>Â© {footerYear} Nathan Bullock. Built in Astro, deployed on Cloudflare Pages.</p>
          <div class="chip-row" role="list">
            <a role="listitem" href="/projects/" class="button button--ghost">Projects</a>
            <a role="listitem" href="/blog/" class="button button--ghost">Lab Notes</a>
          </div>
        </div>
      </div>
    </footer>
    <BackToTopButton />
    <script type="module" src="/src/scripts/theme-toggle.ts"></script>
      <script is:inline>
        (() => {
          const toggle = document.querySelector("[data-nav-toggle]");
          const nav = document.querySelector("[data-nav]");
          if (!toggle || !nav) return;
          const closeNav = () => {
            nav.classList.remove("is-open");
            toggle.setAttribute("aria-expanded", "false");
          };
          toggle.addEventListener("click", () => {
            const isOpen = nav.classList.toggle("is-open");
            toggle.setAttribute("aria-expanded", String(isOpen));
            if (isOpen) {
              const firstLink = nav.querySelector("a");
              firstLink?.focus();
            }
          });
        document.addEventListener("keyup", (event) => {
          if (event.key === "Escape") {
            closeNav();
            toggle.focus();
          }
        });
        nav.addEventListener("click", (event) => {
          if (event.target instanceof HTMLAnchorElement) {
            closeNav();
          }
        });
      })();
    </script>
  </body>
</html>
