---
import BaseHead from "../components/BaseHead.astro";
import "../styles/global.css";
import ambientScript from "../scripts/ambient-canvas.ts?raw";
import BackToTopButton from "../components/BackToTopButton.astro";
import { SearchDialog } from "../components/SearchDialog";

interface Props {
  title?: string;
  description?: string;
  image?: string;
  structuredData?: Array<Record<string, unknown>> | Record<string, unknown>;
}

const {
  title = "nbdevlab — Nathan Bullock",
  description = "Builder notes, project breakdowns, and homelab experiments from nbdevlab.",
  image,
  structuredData,
} = Astro.props as Props;

const NAV_LINKS = [
  { href: "/", label: "Home" },
  { href: "/about/", label: "About" },
  { href: "/projects/", label: "Projects" },
  { href: "/uses/", label: "Uses" },
  { href: "/now/", label: "Now" },
  { href: "/status/", label: "Status" },
  { href: "/admin/", label: "Admin" },
] as const;

const currentPath = Astro.url.pathname.replace(/\/+/g, "/");

function isActive(href: string) {
  return href === "/" ? currentPath === "/" : currentPath.startsWith(href);
}

const footerYear = new Date().getFullYear();
---
<!DOCTYPE html>
<html lang="en" data-theme="dark">
  <head>
    <BaseHead title={title} description={description} image={image} structuredData={structuredData} />
  </head>
  <body>
    <div class="ambient-field" aria-hidden="true"></div>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <header class="site-header" role="banner">
      <div class="layout-shell">
        <div class="site-header__inner">
          <a class="site-brand" href="/">
            <span class="site-brand__logo" aria-hidden="true">NB</span>
            <span class="sr-only">nbdevlab — Home</span>
            <span aria-hidden="true">nbdevlab</span>
          </a>
          <button
            type="button"
            class="site-nav__toggle"
            data-nav-toggle
            aria-label="Toggle navigation"
            aria-controls="site-navigation"
            aria-expanded="false"
          >
            Menu
          </button>
          <nav
            id="site-navigation"
            class="site-nav"
            aria-label="Primary navigation"
            data-nav
            data-open="false"
          >
            <ul class="site-nav__list">
              {NAV_LINKS.map((item) => (
                <li>
                  <a class={isActive(item.href) ? "is-active" : undefined} href={item.href}>
                    {item.label}
                  </a>
                </li>
              ))}
            </ul>
            <div class="site-nav__utilities">
              <SearchDialog client:load />
            </div>
          </nav>
        </div>
      </div>
    </header>
    <main id="main-content" class="site-main">
      <div class="layout-shell">
        <slot />
      </div>
    </main>
    <footer class="site-footer">
      <div class="layout-shell">
        <div class="site-footer__row">
          <p>© {footerYear} Nathan Bullock. Built in Astro, deployed on Cloudflare Pages.</p>
          <div class="chip-row" role="list">
            <a role="listitem" href="/projects/" class="button button--ghost">Projects</a>
            <a role="listitem" href="/blog/" class="button button--ghost">Lab Notes</a>
          </div>
        </div>
      </div>
    </footer>
    <BackToTopButton />
    <script type="module" is:inline>{ambientScript}</script>
    <script is:inline>
      (() => {
        const toggle = document.querySelector<HTMLButtonElement>("[data-nav-toggle]");
        const nav = document.querySelector<HTMLElement>("[data-nav]");
        if (!toggle || !nav) return;

        const closeNav = () => {
          nav.dataset.open = "false";
          toggle.setAttribute("aria-expanded", "false");
        };

        toggle.addEventListener("click", () => {
          const isOpen = nav.dataset.open === "true";
          const next = !isOpen;
          nav.dataset.open = String(next);
          toggle.setAttribute("aria-expanded", String(next));
          if (next) {
            const firstLink = nav.querySelector<HTMLAnchorElement>("a");
            firstLink?.focus();
          }
        });

        document.addEventListener("keyup", (event) => {
          if (event.key === "Escape") {
            closeNav();
            toggle.focus();
          }
        });

        nav.addEventListener("click", (event) => {
          if (event.target instanceof HTMLAnchorElement) {
            closeNav();
          }
        });
      })();
    </script>
  </body>
</html>
